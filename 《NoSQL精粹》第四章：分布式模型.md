# 分布式模型
催生`NoSQL`的主要原因是：我们需要一种能够运行在大集群上的数据库。

方式：

* 纵向扩展：购买更大的服务器。
* 横向扩展：将数据库运行在集群上。

分布式模型有很多，有些模型的数据存储能够处理大量数据，还有些能够更好地应对网络速度慢或网络故障等状况。这些优势都十分重要，不过它们都有其成本。在集群上运行数据库比较复杂，所以除非刚才说的那些优点确有必要，否则不应随意选用。

> 简单的往往是最好的，有时候单一服务器能解决的问题，就没必要使用分布式模型。

数据分布的方式：

* 单一服务器
* 分片
* 复制
  * 主从复制
  * 对等复制

> 复制和分片是两项“正交”的技术：既可以在两者中选一个来用，也可以同时使用它们。

## 单一服务器
大多数情况下，都推荐使用最简单的分布形式：就是根本不分布。将数据库放在一台电脑中，让它处理对数据存储的读取和写入操作，这种方式好就好在不用考虑使用其他方案时所需应对的复杂事务，这对数据操作管理者与应用程序开发者来说，都比较简单。

尽管许多`NoSQL`数据库都是为集群运行环境而设计的，但是只要某个`NoSQL`数据库的数据模型符合应用程序需求，那就完全可以按照单一服务器的分布模型来用它。图数据库显然属于此类：它们最好配置在一台服务器上，若使用数据库基本上是为了处理聚合，那么可以考虑在单一服务器上部署`文档数据库`或`键值数据库`，这样也能简化应用程序开发者的工作。

## 分片
把数据的各个部分存放于不同的服务器中，以此实现横向扩展，这项技术称为`分片`。

![](http://oczira72b.bkt.clouddn.com/17-11-6/76168112.jpg)

在理想情况下，不同的服务器节点会服务于不同的用户。每位用户只需与一台服务器通信，并且很快能获得服务器的响应。网络负载相当均衡地分布于各台服务器。比方说，如果有`10`台服务器，那么每台服务器只需分担`10%`的负载。

理想状况比较罕见。为了获得近乎理想的效果，必须保证需要同时访问的那些数据都存放在同一节点上，而且节点必须排布好这些数据块，使访问速度最优。

那么存放数据的方式，就是以**聚合**为单位，之所以设计**聚合**这一数据结构，就是为了把那些经常需要同时访问的数据放在一起。因此，显然可以把**聚合**作为分布数据的单元。

还有以下改善性能的方法：

* 若是能够确定聚合的访问者基本上都处在某个地理范围内，那么就可以把数据放得离访问者近一些。
* 保持负载均衡。意思是：把聚合数据均匀地分布在各个节点中，让它们需要处理的负载量相等。
* 在某些情况下，可以把有可能需要依次读取的聚合放在一起。

很多`NoSQL`数据库都提供了**自动分片**功能，可以让数据库自己负责把数据分布到各分片，并且将数据访问请求引导至适当的分片上。这样一来，应用程序使用分片就方便多了。

**分片**提升性能主要体现在可以同时提升**读取**与**写入**效率上。使用**复制**，尤其是带缓存的复制，可以极大改善**读取**性能，但对于那种需要频繁**写入**操作的应用程序，却帮助不大。

但是，分片对改善数据库的故障恢复能力帮助并不大。只要某节点出错，那么该分片上的数据就无法访问了。它提供的弹性仅仅在于：只有访问此数据的那些用户才会受影响，而其它用户则能正常访问。

> 最后，注意分片技术不能草率决定，如果决定使用分片，最好是开发伊始就将其部署在集群上，在进入产品上线阶段之后，当然更要如此。而在另外一些情况下，如果想对原来运行在单一服务器上的数据库应用分片技术，则要三思而后行。最好的办法是先使用一台服务器，等到现有服务能力已经明显无法应对负载量时，再改用分片。

## 主从复制

![](http://oczira72b.bkt.clouddn.com/17-11-6/87634111.jpg)

主从式分布指的把数据复制到多个节点上。其中有一个节点叫做**主节点**，或**主要节点**。主节点存放权威数据，而且通常负责数据更新操作。其余节点都叫**从节点**，或**次要节点**。复制操作就要让从节点与主节点同步。

在需要频繁读取数据集的情况下，主从复制最有助于提升数据访问性能。以新增更多从节点的方式来进行水平扩展，就可以同时处理更多的数据读取请求，并且能保证将所有请求都引导至从节点。然而，数据库仍然受制于主节点处理更新，以及向从节点发布更新的能力。所以在写入操作特别频繁的场合，虽说将读取操作分流，可以稍微缓解写入操作的处理压力，但是这样安排数据集的效果并不好。

主从复制的第二个好处是可以增强**读取操作的故障恢复能力**：万一主节点出错了，那么从节点依然可以处理读取请求。然而，当主节点出错之后，除非将其恢复，或另行指派新的主节点，否则数据库就无法处理写入操作了。然而，拥有内容与主节点相同的从节点，可以提高数据库恢复速度，因为主节点出错之后，很快能指派一个从节点作为新的主节点。

> 注意，主节点可以手工指派，也可自动选择。建议自动选择主节点，不仅配置起来较为简单，而且当主节点出错时，集群可以自动指派新的主节点，以减少停机时间。

并且，在上述情况下，其实从节点充当了**即时备份**。整个系统的故障恢复能力和稳定性提升了。

复制技术虽然好处多多，但也有一个不可避免的**缺陷**，那就是数据的不一致性，如果数据更新还没有全部通知给从节点，那么不同的客户端就可能于不同的从节点读出内容各异的值。在最糟糕的情况下，客户端甚至无法读出它刚刚写入的那个值。就算使用主从复制也只是为了做**即时备份**，还有就是，一旦主节点出错，那么尚未更新到从节点的数据会被丢失。

## 对等复制
对等复制没有主节点这一概念，所有副本地位相同，都可以接受写入请求，而且丢失其中一个副本，并不影响整个数据库的访问。

![](http://oczira72b.bkt.clouddn.com/17-11-6/53538243.jpg)

其优势是在集群上使用对等复制方案时，可以从容处理出错的节点，而不必担心数据请求会丢失。另外，只需增加节点，就能轻易提升性能。

但其最大的麻烦还是数据的一致性。由于两个不同的节点可以同时处理写入操作，所以有可能出现两位用户在同一时间试图更新同一条记录的情况，这就导致**写入冲突**，数据读取的不一致也是个问题，不过它们至少持续时间相对较短，而写入操作导致的不一致数据却总是存在。

解决写入冲突的两种方式：

* 使用锁来实现写入与读取的协调
* 设法处理不一致的写入操作

## 结合分片与复制技术
下图展示了同时使用主从复制与分片技术：

![](http://oczira72b.bkt.clouddn.com/17-11-6/26079186.jpg)

* 对于每项数据来说，负责它的主节点只有一个。
* 对于每台服务器来说，其可做一项数据的主节点，同时可以做另一项数据的子节点。

而使用列族数据库时，有经常会把对等复制和分片结合起来，对每项数据分片，并且对等复制到一组服务器中。多组服务器构成一个集群。如图所示：

![](http://oczira72b.bkt.clouddn.com/17-11-6/99345916.jpg)

## 要点
* 数据分布有两种方式：
  * 将不同的数据分片存放在多个服务器中，每一个数据子集专门由一台服务器负责。
  * 将数据复制到多个服务器上，每份数据都能在多个节点中找到。

数据库系统可以只选用其中一种技术，也可以两种都选用。

* 复制技术又有两种形式
  * 主从复制：将其中一个节点当做权威数据源，并负责写入操作；其他从节点都要和主节点保持同步，它们可以负责读取操作。
  * 对等复制：任何节点均可写入，节点间相互协调以同步其数据。

主从复制减少了更新数据时的冲突几率，但它却会让主节点成为写入操作的瓶颈，而对等复制则避免了这一点。