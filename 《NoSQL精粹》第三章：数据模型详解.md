# 数据模型详解
## 关系
聚合的有用之处在于它可以把经常访问的数据存放在一起。但在有些情况下，我们需要以不同方式来访问相互关联的数据。

如果两个聚合之间有了关系，那么一个重要问题就是如何更新其数据。面向聚合数据库获取数据时以聚合为单元，因此，它只能保证单一聚合内部内容的原子性。如果一次更新多个聚合，那就必须设法应对中途发生的错误。若要在关系型数据库中同时修改多条记录，可以把它们放在一个事务中执行，这样在改动多行内容时，还能保证本次操作的`ACID`属性。

虽然面向聚合的数据库有很多种办法能够应对此情况，但始终还是显得比较笨拙。所以如果待处理的数据中存在大量关系，那么这意味着更应该选用关系型数据库，而不是`NoSQL`型数据库。

## 图数据库
虽然面向聚合的数据库处理复杂的关系时效果不好，但是大家也明白，关系型数据库应对这一问题时表现也不尽如人意。查询时可将多个表用`SQL`的`JOIN`谓词连接起来，然而那么做很快就会让代码变得糟糕。随着`JOIN`子句数量越来越多，`SQL`语句更加难写，而且查询效率也更低了。

图数据库就是为了解决关系型数据库的另外一项缺点而设计的，因此其数据模型也与其他`NoSQL`数据库相反。

![](http://oczira72b.bkt.clouddn.com/17-11-4/29479832.jpg)

图数据库专门擅长捕捉复杂信息，不过它处理的数据规模，比这种我们能一眼望尽的图要大很多。

图数据库的基本模型很简单：由边连接而成的若干节点。在图数据库中遍历关系非常迅速。很大一部分原因是由于图数据库会多花一些时间用于插入关系数据，以此来缩短遍历关系时所需的时间。它与面向聚合数据库的明显差异，就在于其重视数据间的关系。这种数据模型上的差异也导致了其他方面的一些区别。这种图形数据库通常运行在单一服务器上，而不是集群中。为了使数据保持一致，`ACID`事务需要涵盖多个节点和边。它和面向聚合数据库数据库仅有的相似之处在于，二者都不使用关系模型。

## 无模式数据库
各种形式的`NoSQL`数据库有个共同点，那就是它们都没有模式。若要在关系型数据库中存储数据，首先必须定义模式，也就是用一种预定义结构向数据库说明：有哪些表，表中有哪些列，每一列都存放何种类型的数据。必须先定义好模式，然后才能存放数据。

相比之下，`NoSQL`数据库的数据存储就比较随意了。键值数据库可以把任何数据存放在一个键的名下。文档数据库实际上也如此，因为它对所存储的文档结构没有限制。在列族数据库中，任意列里面都可以随意存放数据。图数据库中新增边，也可以随意向节点和边中添加属性。

无模式数据库自由且灵活。如果用了模式，那么就必须提前指明你要存储的数据。我们很容易根据项目需要来修改原有的数据存储方式，一旦发现了新东西，只要把它们加入数据库就好了。而对于使用模式的关系型数据库中，如果删除了某列，那么你恐怕得担心此操作会不会导致旧数据丢失。

除了更改数据方面的差别外，无模式数据库也更容易处理**“格式不一致的数据”**，也就是那种每条记录都拥有不同字段集的数据。模式会将表内每一行的数据强行统一。而无模式表则没有这么麻烦，每条记录只要包含其需要的数据即可。

然而在编写数据访问程序时，必须面对一个关键问题：尽管有时不甚方便，但程序通常要依赖于某种形式的**“隐含模式”**，它是指在编写数据数据操作代码时，对数据结构所做的一系列假设。

但是，隐含模式还是可能带来一些问题，因为模式完全取决于应用程序的代码是否清晰。此外，无模式数据库感知不到模式，所以它无法用模式来提升存储与获取数据的效率，它也无法自行验证，以防止多个应用程序以不一致的方式操作其数据。

本质上，无模式数据库是把模式交给应用程序代码来处理了。如果由多个应用程序要访问相同的数据库，有几个方法缓解此问题：

* 将数据库互动操作封装成独立的应用程序，并通过`Web服务`将它与其他应用程序集成。
* 在聚合中为不同应用程序划分不同区域。在文档数据库中，可以把文档分成不同的区段；在列族数据库中，可以把不同的列族分给不同的应用程序。

数据库选择时：如果发现待存储的数据类型不统一，那么应该优选无模式数据库。

无模式的灵活性仅限于聚合内部，如果改动了聚合边界，那么其数据迁移工作和关系型数据库一样，都特别复杂。

## 物化视图
关系型数据库的优势在于视图机制，其展示数据的角度与数据库存储数据的方式有所不同。

物化视图是预先算好并缓存在磁盘中的视图。如果数据读取非常频繁，而访问者又不介意略显陈旧的数据，那么使用物化视图效率比较高。

`NoSQL`没有视图，但是可以预先计算查询操作的结果，并将其缓存起来。这就是`NoSQL`的物化视图。

构建物化视图的两种办法：

* 每次基础数据变动就更新，如果读取物化视图的次数远比写入次数多，而且想获得更为及时的数据，那么这种方法比较合适。
* 定时用定时任务来更新。

> 对于列族数据库而言，会根据不同列族来创建物化视图。

## 构建数据存取模型
* 对于键值数据库而言，可以通过键读取整个对象，然后由客户端解析，可以在某一对象中保留另一个聚合内数据需要查询`ID`。
* 对于文档数据库而言，其能够快速在文档内搜寻，故可以直接保存内容。
* 对于列族数据库而言，依据查询优先级决定其在数据库中存储的排序优先级。

## 要点
* 使用面向聚合的数据库处理不同聚合之间的关系，要比处理同一聚合内部的关系更难。
* 图数据库将数据组织成一张由节点和边所组成的图，它们适合处理关系复杂的数据结构。
* 在无模式数据库中，可以给记录随意增加字段，然而用户在使用数据时，通常还是要遵循一套隐式模式。
* 面向聚合的数据库通常能够用不同方式重组主聚合的数据，以计算出各种物化视图。计算过程一般通过“映射化简”来实现。